angular.module("ecstatic.player").factory("playerServices",["$rootScope","$sce","$stateParams","ConfigService","socket","socketManager","$timeout","channelServices",function(e,t,n,a,o,s,r,i){var c={};return c.soundcloudClientId=0,a.getConfig().then(function(e){c.soundcloudClientId=e.soundcloudClientId}),o.on("next_song_action",function(t){e.$broadcast("nextSong")}),c.getSocketId=function(){var e={msg:"get_socket_id"};o.on("get_socket_id",function(e){s.listener(e)});var t=s.sendRequest(e);return t},c.nextSongAction=function(e,t){var n={msg:"next_song_action",channel_id:t,playlistIndex:e},a=s.sendRequest(n);return a},c.setChannel=function(e){c.currentItem=e.playlistIndex,c.autoplay=!0,c.playlist=e.playlist,c.channel=e,c.sources=[],c.theme="http://www.videogular.com/styles/themes/default/latest/videogular.css"},c.onLoadMetaData=function(e){c.API.seekTime(c.delta,!1),c.API.mediaElement[0].removeEventListener("loadedmetadata",this.onLoadMetaData.bind(this),!1)},c.onPlayerReady=function(e){c.API=e,c.API.setVolume(1);var t=i.getChannel(n.channel_id);t.hasCountdown?i.setCountdownFinished(n.channel_id):(c.API.mediaElement[0].addEventListener("loadedmetadata",this.onLoadMetaData.bind(this),!1),c.delta=(c.channel.requestTime-c.channel.timestamp)/1e3),c.setItem(c.currentItem)},c.onCompleteItem=function(){c.isCompleted=!0,c.currentItem++,c.delta=0,c.currentItem>=c.playlist.length&&(c.currentItem=0),c.setItem(c.currentItem)},c.setItem=function(e){c.API.stop(),c.currentItem=e,c.sources=[];var n=c.playlist[c.currentItem];c.sources.push({src:t.trustAsResourceUrl(n.stream_url+"?client_id="+c.soundcloudClientId),type:"audio/"+n.original_format}),c.trackTitle=c.playlist[c.currentItem].title,c.trackUser=c.playlist[c.currentItem].user.username,c.trackCover=c.playlist[c.currentItem].artwork_url,r(c.API.play.bind(c.API),100)},c}]).service("countdownEventService",["$rootScope",function(e){this.broadcast=function(){e.$broadcast("countdownFinished")},this.listen=function(t){e.$on("countdownFinished",t)}}]);