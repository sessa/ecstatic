"use strict";var app,express,cors,bodyParser,client,io,async,socket,http,server,nodemailer,smtpTransport,aws,s3;client=require("redis").createClient(6379,process.env.cache,{no_ready_check:!0}),express=require("express"),cors=require("cors"),bodyParser=require("body-parser"),app=express(),app.set("views",__dirname+"/"),console.log("dirname="+__dirname),app.set("view engine","jade"),app.set("port",3001),app.use(express["static"]("./")),app.use(cors()),async=require("async"),server=require("http").Server(app),io=require("socket.io")(server),nodemailer=require("nodemailer"),smtpTransport=require("nodemailer-smtp-transport");var urlencodedParser=bodyParser.urlencoded({extended:!1});aws=require("aws-sdk"),s3=new aws.S3,io.sockets.on("connection",function(e){function n(e,n){client.get(e,function(t,a){var i=JSON.parse(a);"player_state"in i&&(i.player_state.users=io.sockets.adapter.rooms[e],i.player_state.requestTime=(new Date).getTime()),n(null,i)})}function t(n){e.broadcast.to(n).emit("update",{channel_id:n}),e.emit("update",{channel_id:n})}var a;client.set(e.id,JSON.stringify({})),e.on("disconnect",function(){var e=io.sockets.adapter.rooms[a],n="undefined"!=typeof e?Object.keys(e).length:0;0===n&&client.lrem("roomlist",0,a,function(e){console.log("err="+e)})}),e.on("get_socket_id",function(n){e.emit("get_socket_id",{socket_id:e.id,callback_id:n.callback_id})}),e.on("create_channel",function(n){client.lrange("roomlist",0,-1,function(n,t){if(Object.keys(t).length>1)for(var a in t)a!==e.id&&e.leave(a)}),client.get(e.id,function(t,i){var o=JSON.parse(i);o.player_state={is_playing:1,is_locked:0,playlistIndex:0,timestamp:(new Date).getTime(),requestTime:(new Date).getTime(),channel_name:n.channel_name,channel_id:e.id,cliplist:[],hasCountdown:!0,start_time:n.start_time,chat:[],playlist:[]},client.set(e.id,JSON.stringify(o)),client.lpush("roomlist",e.id),a=e.id,o.callback_id=n.callback_id,io.sockets.emit("create_channel",o)})}),e.on("channelList",function(t){client.lrange("roomlist",0,-1,function(a,i){var o=[];for(var s in i)o.push(i[s]);async.map(o,n,function(n,a){console.log("inside async map"),e.emit("channelList",{channelList:a,callback_id:t.callback_id})})})}),e.on("next_song_action",function(n){console.log("next_song, data="+JSON.stringify(n)),client.get(n.channel_id,function(t,a){var i=JSON.parse(a);i.player_state.playlistIndex=n.playlistIndex,i.player_state.timestamp=(new Date).getTime(),client.set(n.channel_id,JSON.stringify(i)),i.callback_id=n.callback_id,e.broadcast.to(n.channel_id).emit("next_song_action",i)})}),e.on("join_channel",function(n){console.log("socket.rooms"+e.rooms),e.rooms.indexOf(n.channel_id)<0&&(e.join(n.channel_id),a=n.channel_id,t(n.channel_id))}),e.on("send_video",function(e){console.log("Inside send mobile video on server.js "+e.channel_id),client.get(e.channel_id,function(n,a){var i={Bucket:"ecstatic-videos",Key:e.video_key,Body:e.video};s3.putObject(i,function(n,i){if(n)console.log("Server - send_video_to_s3 - Error Uploading Video to S3 \n"+n);else{console.log("Successfully uploaded data to myBucket/myKey");var o={hasVideo:e.hasVideo,isActive:e.isActive,video_key:e.video_key,username:e.username,format:e.format},s=JSON.parse(a);s.player_state.cliplist.push(o),client.set(e.channel_id,JSON.stringify(s)),t(e.channel_id)}})})}),e.on("send_text",function(n){client.get(n.channel_id,function(t,a){var i={txt:n.txt,username:n.username};a=JSON.parse(a),a.player_state.chat.push(i),client.set(n.channel_id,JSON.stringify(a)),e.broadcast.to(n.channel_id).emit("send_text",i)})}),e.on("chat_backlog",function(n){client.get(n.channel_id,function(n,t){t=JSON.parse(t),e.emit("chat_backlog",t.player_state.chat)})}),e.on("update_channel",function(e){client.get(e.channel_id,function(n,a){var i=JSON.parse(a);i.player_state=e.channel_info,client.set(e.channel_info.channel_id,JSON.stringify(i)),i.callback_id=e.callback_id,t(e.channel_info.channel_id)})}),e.on("setCountdownFinished",function(e){console.log("heard countdown finished"),client.get(e.channel_id,function(n,a){var i=JSON.parse(a);i.player_state.hasCountdown=!1,i.player_state.timestamp=(new Date).getTime(),client.set(e.channel_id,JSON.stringify(i)),i.callback_id=e.callback_id,t(e.channel_id)})})}),app.post("/feedback",urlencodedParser,function(e,n){var t=nodemailer.createTransport(smtpTransport({host:"smtp.mailgun.org",port:25,auth:{user:"postmaster@sandboxe5272feb9c3c4b3c88e6e69d8379de8f.mailgun.org",pass:"062303775835e3826aa39a0d60902ac0"}})),a={from:e.body.name+" &lt;"+e.body.email+"&gt;",to:"jonathan@silentdiscosquad.com",subject:"Ecstatic App Feedback",text:e.body.message};t.sendMail(a,function(e,t){e?console.log(e):(console.log("Message sent: "+t.response),n.redirect("#/app/feedback/thankyou"))})}),app.get("/soundcloud/callback",function(e,n){n.render("soundcloud/callback")}),app.get("/soundcloudClientId",function(e,n){n.json({soundcloudClientId:process.env.soundcloudClientId})}),app.get("/*",function(e,n){n.render("index")}),server.listen(app.get("port"),function(e,n){console.log("Server listening at "+app.get("port"))});